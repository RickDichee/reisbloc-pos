rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== DEVELOPMENT MODE (Emulators) =====
    // En emuladores, usar reglas permisivas. Esto se detecta por la ausencia de auth.token.iss
    function isDevelopment() {
      return request.auth == null || request.auth.token.iss == null;
    }
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return userData != null ? userData : {};
    }
    
    function getUserRole() {
      return isAuthenticated()
        ? (request.auth.token.role != null ? request.auth.token.role : getUserData().role)
        : null;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    function isCapitan() {
      return isAuthenticated() && getUserRole() == 'capitan';
    }
    
    function isSupervisor() {
      return isAuthenticated() && getUserRole() == 'supervisor';
    }
    
    function isKitchen() {
      return isAuthenticated() && getUserRole() == 'cocina';
    }
    
    function isBar() {
      return isAuthenticated() && getUserRole() == 'bar';
    }
    
    function isMesero() {
      return isAuthenticated() && getUserRole() == 'mesero';
    }

    // Global read-only switch (set by admin in settings/system { readOnly: true })
    function isSystemReadOnly() {
      let systemSettings = get(/databases/$(database)/documents/settings/system).data;
      return systemSettings != null && systemSettings.readOnly == true;
    }
    
    function canManageOrders() {
      return isAdmin() || isCapitan() || isMesero();
    }
    
    function canReadOrders() {
      return isAuthenticated() || isDevelopment();
    }
    
    // USERS: Lectura sin auth para login; solo admin modifica
    match /users/{userId} {
      allow read: if true; // Permitir lectura para proceso de login
      allow create, update, delete: if isDevelopment() || isAdmin();
    }
    
    // SETTINGS: Configuración global (readOnly flag)
    match /settings/{settingId} {
      allow read: if true;
      allow create, update, delete: if isDevelopment() || isAdmin();
    }
    
    // DEVICES: Permitir registro sin auth; admin aprueba
    match /devices/{deviceId} {
      allow read: if true; // Permitir lectura
      allow create: if isDevelopment() || isAuthenticated(); // Permitir a usuarios autenticados crear dispositivos
      allow update: if isDevelopment() || isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow delete: if isDevelopment() || isAdmin();
    }
    
    // PRODUCTS: Lectura pública; solo admin modifica
    match /products/{productId} {
      allow read, list: if true; // Todos pueden leer productos
      allow create: if isDevelopment() || (isAdmin() && !isSystemReadOnly());
      allow update: if isDevelopment() || isAdmin() || (!isSystemReadOnly() && (isCapitan() || isMesero() || isKitchen() || isBar()));
      allow delete: if isDevelopment() || (isAdmin() && !isSystemReadOnly());
    }
    
    // ORDERS: Todos leen; admin/capitan/mesero crean/modifican; cocina actualiza status
    match /orders/{orderId} {
      allow read, list: if canReadOrders();
      allow create: if isDevelopment() || ((canManageOrders() || isBar()) && !isSystemReadOnly());
      allow update: if isDevelopment() || ((isAdmin() || canManageOrders() || isKitchen() || isBar()) && !isSystemReadOnly());
      allow delete: if isDevelopment() || ((isAdmin() || isCapitan()) && !isSystemReadOnly());
    }
    
    // SALES: Todos con acceso leen; admin/capitan/bar crean
    match /sales/{saleId} {
      allow read: if isAuthenticated() || isDevelopment();
      allow create: if isDevelopment() || ((canManageOrders() || isBar()) && !isSystemReadOnly());
      allow update, delete: if isDevelopment() || (isAdmin() && !isSystemReadOnly());
    }
    
    // DAILY CLOSES: Solo admin gestiona
    match /daily_closes/{closeId} {
      allow read: if isDevelopment() || isAdmin() || isSupervisor();
      allow create, update, delete: if isDevelopment() || (isAdmin() && !isSystemReadOnly());
    }

    // CLOSINGS: Registros operativos de cierre de caja (colección legacy)
    match /closings/{closeId} {
      allow read: if isDevelopment() || isAdmin() || isSupervisor();
      allow create, update, delete: if isDevelopment() || (isAdmin() && !isSystemReadOnly());
    }
    
    // AUDIT LOGS: Solo admin y supervisor leen; cualquiera autenticado crea
    match /audit_logs/{logId} {
      allow read: if isDevelopment() || isAdmin() || isSupervisor();
      allow create: if isDevelopment() || !isSystemReadOnly();
      allow update, delete: if false; // Los logs no se modifican
    }
    
    // CLIP PAYMENTS: Igual que sales
    match /clip_payments/{paymentId} {
      allow read: if isAuthenticated() || isDevelopment();
      allow create: if isDevelopment() || (canManageOrders() || isBar());
      allow update: if isDevelopment() || isAdmin();
      allow delete: if isDevelopment() || isAdmin();
    }
    
    // NOTIFICATIONS: Usuario puede leer/actualizar sus propias notificaciones
    match /notifications/{notificationId} {
      allow read: if isDevelopment() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isDevelopment() || (isAuthenticated() && !isSystemReadOnly()); // Fallback crea notificaciones (requiere auth)
      allow update: if isDevelopment() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow delete: if isDevelopment() || (isAuthenticated() && resource.data.userId == request.auth.uid);
    }
  }
}
